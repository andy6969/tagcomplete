/**
*APACHE 2.0 LICENSE
*@author: Razak Zakari <razzsense@gmail.com>
 */!function(t){t.fn.addTag=function(a,e,n){closeTag="<span class='close'></span>",tag=t("<span data-id='"+e+"' class='tag'>"+n+closeTag+"</span>"),a.append(tag)},t.fn.getTagInfo=function(t,a){return selector=".tag:nth-child("+a+")",tagDom=t.find(selector),tagText=tagDom.text(),tagId=tagDom.data("id"),tagInfo={id:tagId,text:tagText,selector:tagDom},tagInfo},t.fn.deleteTag=function(a){t(a).remove()},t.fn.updateAutoComplete=function(a,e){var n="";t.each(e,function(t,a){n+="<li data-id='"+t+"'>"+a+"</li>"}),a.empty().html(n).removeClass("hide"),a.parent(".tag_complete_main").find(".tag_complete").addClass("has_autocomplete")},t.fn.clearAutoComplete=function(t){t.addClass("hide").empty(),t.parent(".tag_complete_main").find(".tag_complete").removeClass("has_autocomplete")},t.fn.abortAjax=function(a){a.length>0&&t.each(a,function(t,a){a.abort()})},t.fn.refreshUserInput=function(a,e,n){if(tokenizer=n.tokenizer,tokenizedData="",tags=e.find(".tag"),0==tags.length)return!1;t.each(tags,function(a,e){tagData=t(this).data("id")||t(this).text(),tokenizedData+=tagData+","}),tokenizedData=tokenizedData.slice(0,tokenizedData.lastIndexOf(",")),a.val(tokenizedData)},t.fn.tagComplete=function(a){var e={keylimit:1,tokenizer:",",freeinput:!0,autocomplete:{data:[],ajaxOpts:{method:"GET",dataType:"json",data:{}},params:function(t){return{q:t,lol:23}},proccessData:function(t){return t}}},n=t.extend(!0,e,a);return this.each(function(){self=t(this),userInput=t(this),userInput.addClass("hide");var a=t("<div class='tag_complete_main'></div>"),e=t("<div class='tag_complete'></div>");a.append(e);var o=t("<ul class='autocomplete hide'></ul>");a.append(o),e.append("<div class='tags_container'></div>"),tagsContainer=e.find(".tags_container"),a.insertAfter(userInput),tagInput=t("<input type='text' class='tag_input' />"),e.append(tagInput),e.on("click",function(){tagInput.focus()}),tagInput.on("focus",function(){e.addClass("is_focused")}).on("blur",function(){e.removeClass("is_focused")}),tagsContainer.on("click",".tag .close",function(a){t(this).parent(".tag").remove(),t.fn.refreshUserInput(userInput,tagsContainer,n)}),o.on("click","li",function(a){a.preventDefault();var e=t(this).data("id");t.fn.addTag(tagsContainer,e,t(this).text()),t.fn.refreshUserInput(userInput,tagsContainer,n),tagInput.val(""),t.fn.abortAjax(ajaxPool),t.fn.clearAutoComplete(o)}),ajaxPool=[],tagInput.on("keyup",function(a){if(value=t(this).val(),keycode=a.keyCode?a.keyCode:a.which,0==value.length&&t.fn.clearAutoComplete(o),0==value.length&&8==keycode)return lastTagNo=tagsContainer.find(".tag").length,0!=lastTagNo&&(lastTagInfo=t.fn.getTagInfo(tagsContainer,lastTagNo),lastTagInfo.selector.remove(),tagInput.val(lastTagInfo.text),t.fn.refreshUserInput(userInput,tagsContainer,n),self);if((13==keycode||a.key==n.tokenizer)&&value.length>0&&1==n.freeinput)return value=value.slice(0,value.lastIndexOf(n.tokenizer)),t.fn.addTag(tagsContainer,value,value),t(this).val(""),t.fn.abortAjax(ajaxPool),t.fn.clearAutoComplete(o),t.fn.refreshUserInput(userInput,tagsContainer,n),self;if(autoCompeleteData=n.autocomplete.data,matchedData={},1==n.freeinput&&(matchedData[value]=value),value.length<n.keylimit)return self;if("object"==typeof n.autocomplete.data){for(i=0;i<autoCompeleteData.length;i++)dataWord=autoCompeleteData[i],-1!=dataWord.indexOf(value)&&(matchedData[dataWord]=dataWord);t.fn.updateAutoComplete(o,matchedData)}dataUrl=n.autocomplete.ajaxOpts.url,null!=dataUrl&&(ajaxOpts=n.autocomplete.ajaxOpts,params=n.autocomplete.params.call(null,value),ajaxOpts.data=t.extend(n.data,params),ajaxReq=t.ajax(ajaxOpts).success(function(a){if(proccessedData=n.autocomplete.proccessData.call(null,a),0==proccessedData.length)return!1;t.extend(matchedData,proccessedData),t.fn.updateAutoComplete(o,matchedData)}),ajaxPool.push(ajaxReq))})})}}(jQuery);