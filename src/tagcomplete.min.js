/***APACHE 2.0 LICENSE
*@author: "Razak Zakari" razzsense@gmail.com
 */!function(t){t.fn.tagComplete=function(a){var e={keylimit:1,tokenizer:",",freeinput:!0,autocomplete:{ajaxOpts:{method:"GET",dataType:"json",data:{}},params:function(t){return{q:t,lol:23}},proccessData:function(t){return t},data:[]}},n=t.extend(!0,e,a);return this.each(function(){ajaxPool=[],userInput=self=t(this),userInput.addClass("hide"),tagCompleteMain=t("<div class='tag_complete_main'><div class='tag_complete'><div class='tags_container'></div><input type='text' class='tag_input' /></div><ul class='autocomplete hide'></ul></div>"),tagCompleteMain.insertAfter(userInput),tagComplete=tagCompleteMain.find(".tag_complete"),tagInput=tagComplete.find(".tag_input"),tagsContainer=tagComplete.find(".tags_container"),autoComplete=tagCompleteMain.find(".autocomplete"),instanceData={userInput:userInput,tagCompleteMain:tagCompleteMain,tagComplete:tagComplete,tagsContainer:tagsContainer,tagInput:tagInput,autoComplete:autoComplete,options:n,ajaxPool:ajaxPool},tagComplete.on("click",instanceData,function(t){t.data.tagInput.focus()}),tagInput.on("focus",instanceData,function(t){t.data.tagComplete.addClass("is_focused")}).on("blur",instanceData,function(t){t.data.tagComplete.removeClass("is_focused")}),autoComplete.on("click","li",instanceData,function(a){inst=a.data;var e=t(this).data("id");t.fn.addTag(inst.tagsContainer,e,t(this).text()),t.fn.refreshUserInput(inst.userInput,inst.tagsContainer,inst.options),tagInput.val(""),t.fn.abortAjax(ajaxPool),t.fn.clearAutoComplete(inst.autoComplete)}),tagsContainer.on("click",".tag .close",instanceData,function(a){inst=a.data,t(this).parent(".tag").remove(),t.fn.refreshUserInput(inst.userInput,inst.tagsContainer,inst.options)}),tagInput.on("keyup",instanceData,function(a){if(instData=a.data,tagCompleteMain=instData.tagCompleteMain,tagComplete=instData.tagComplete,tagsContainer=instData.tagsContainer,tagInput=instData.tagInput,autoComplete=instData.autoComplete,n=instData.options,ajaxPool=instData.ajaxPool,value=t(this).val(),keycode=a.keyCode?a.keyCode:a.which,0==value.length&&t.fn.clearAutoComplete(autoComplete),0==value.length&&8==keycode)return lastTagNo=tagsContainer.find(".tag").length,0!=lastTagNo&&(lastTagInfo=t.fn.getTagInfo(tagsContainer,lastTagNo),lastTagInfo.selector.remove(),tagInput.focus().val("").val(lastTagInfo.text),t.fn.refreshUserInput(userInput,tagsContainer,n),self);if((13==keycode||a.key==n.tokenizer)&&value.length>0&&1==n.freeinput)return value=value.slice(0,value.lastIndexOf(n.tokenizer)),t.fn.addTag(tagsContainer,value,value),t(this).val(""),t.fn.abortAjax(ajaxPool),t.fn.clearAutoComplete(autoComplete),t.fn.refreshUserInput(userInput,tagsContainer,n),self;if(autoCompeleteData=n.autocomplete.data,matchedData={},1==n.freeinput&&(matchedData[value]=value),value.length<n.keylimit)return self;if("object"==typeof n.autocomplete.data){for(i=0;i<autoCompeleteData.length;i++)dataWord=autoCompeleteData[i],-1!=dataWord.indexOf(value)&&(matchedData[dataWord]=dataWord);t.fn.updateAutoComplete(autoComplete,matchedData)}dataUrl=n.autocomplete.ajaxOpts.url,null!=dataUrl&&(ajaxOpts=n.autocomplete.ajaxOpts,params=n.autocomplete.params.call(null,value),ajaxOpts.data=t.extend(n.data,params),ajaxReq=t.ajax(ajaxOpts).success(function(a){if(proccessedData=n.autocomplete.proccessData.call(null,a),0==proccessedData.length)return!1;t.extend(matchedData,proccessedData),t.fn.updateAutoComplete(autoComplete,matchedData)}))})})},t.fn.addTag=function(a,e,n){closeTag="<span class='close'></span>",tag=t("<span data-id='"+e+"' class='tag'>"+n+closeTag+"</span>"),a.append(tag)},t.fn.getTagInfo=function(t,a){return selector=".tag:nth-child("+a+")",tagDom=t.find(selector),tagText=tagDom.text(),tagId=tagDom.data("id"),tagInfo={id:tagId,text:tagText,selector:tagDom},tagInfo},t.fn.updateAutoComplete=function(a,e){var n="";t.each(e,function(t,a){n+="<li data-id='"+t+"'>"+a+"</li>"}),a.empty().html(n).removeClass("hide"),a.parent(".tag_complete_main").find(".tag_complete").addClass("has_autocomplete")},t.fn.clearAutoComplete=function(t){t.addClass("hide").empty(),t.parent(".tag_complete_main").find(".tag_complete").removeClass("has_autocomplete")},t.fn.abortAjax=function(a){a.length>0&&t.each(a,function(t,a){a.abort()})},t.fn.refreshUserInput=function(a,e,n){if(tokenizer=n.tokenizer,tokenizedData="",tags=e.find(".tag"),0==tags.length)return!1;t.each(tags,function(a,e){tagData=t(this).data("id")||t(this).text(),tokenizedData+=tagData+","}),tokenizedData=tokenizedData.slice(0,tokenizedData.lastIndexOf(",")),a.val(tokenizedData)}}(jQuery);